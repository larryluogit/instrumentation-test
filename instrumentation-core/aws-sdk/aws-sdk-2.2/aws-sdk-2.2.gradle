plugins {
  id "com.github.johnrengelman.shadow"
}

ext {
  minJavaVersionForTests = JavaVersion.VERSION_1_8
  noShadowPublish = true
}

group = 'io.opentelemetry.instrumentation'

apply from: "$rootDir/gradle/java.gradle"
apply from: "$rootDir/gradle/publish.gradle"
apply plugin: 'org.unbroken-dome.test-sets'

testSets {
  latestDepTest
}

dependencies {
  // TODO(anuraaga): We currently include common instrumentation logic like decorators in the
  // bootstrap, but we need to move it out so manual instrumentation does not depend on code from
  // the agent, like Agent.
  api project(':auto-bootstrap')

  api deps.opentelemetryApi

  api group: 'software.amazon.awssdk', name: 'aws-core', version: '2.2.0'

  testImplementation project(':testing')

  // Include httpclient instrumentation for testing because it is a dependency for aws-sdk.
  testImplementation project(':instrumentation:apache-httpclient:apache-httpclient-4.0')
  // Also include netty instrumentation because it is used by aws async client
  testImplementation project(':instrumentation:netty:netty-4.1')
  testImplementation group: 'software.amazon.awssdk', name: 'apache-client', version: '2.2.0'
  testImplementation group: 'software.amazon.awssdk', name: 's3', version: '2.2.0'
  testImplementation group: 'software.amazon.awssdk', name: 'rds', version: '2.2.0'
  testImplementation group: 'software.amazon.awssdk', name: 'ec2', version: '2.2.0'
  testImplementation group: 'software.amazon.awssdk', name: 'sqs', version: '2.2.0'
  testImplementation group: 'software.amazon.awssdk', name: 'dynamodb', version: '2.2.0'
  testImplementation group: 'software.amazon.awssdk', name: 'kinesis', version: '2.2.0'
  testImplementation deps.guava

  latestDepTestImplementation project(':instrumentation:apache-httpclient:apache-httpclient-4.0')
  latestDepTestImplementation project(':instrumentation:netty:netty-4.1')

  latestDepTestImplementation group: 'software.amazon.awssdk', name: 'apache-client', version: '+'
  latestDepTestImplementation group: 'software.amazon.awssdk', name: 's3', version: '+'
  latestDepTestImplementation group: 'software.amazon.awssdk', name: 'rds', version: '+'
  latestDepTestImplementation group: 'software.amazon.awssdk', name: 'ec2', version: '+'
  latestDepTestImplementation group: 'software.amazon.awssdk', name: 'sqs', version: '+'
  latestDepTestImplementation group: 'software.amazon.awssdk', name: 'dynamodb', version: '+'
  latestDepTestImplementation group: 'software.amazon.awssdk', name: 'kinesis', version: '+'
}

shadowJar {
  archiveClassifier = 'agent'

  configurations = []

  relocate 'io.opentelemetry.instrumentation.awssdk.v2_2', 'io.opentelemetry.auto.instrumentation.awssdk.v2_2.shaded'
}
